name: Update Static Demo Data

on:
  # Run every 2 hours to keep demo data fresh
  schedule:
    - cron: '0 */2 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
  
  # Run on pushes to main branch for testing
  push:
    branches: [ main ]

env:
  # Python version to use
  PYTHON_VERSION: '3.11'
  # Node.js version for React build
  NODE_VERSION: '18'

jobs:
  update-data:
    name: Export Live Data to Static Files
    runs-on: ubuntu-latest
    
    # Set timeout to prevent hanging jobs
    timeout-minutes: 15
    
    permissions:
      contents: write  # To commit updated data files
      pages: write     # To deploy to GitHub Pages
      id-token: write  # For GitHub Pages deployment
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper commits
          
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests elasticsearch python-dotenv
          
      - name: ğŸŒ Test Network Connectivity
        run: |
          echo "Testing connectivity to data source..."
          # Test if we can reach the Elasticsearch/API endpoint
          curl -f --max-time 10 --retry 3 ${{ secrets.API_BASE_URL }}/health || {
            echo "âŒ Cannot connect to data source"
            echo "This is expected for the static demo - data source is not publicly accessible"
            exit 0
          }
          
      - name: ğŸ“Š Export Live Data
        id: export
        continue-on-error: true
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          ES_HOST: ${{ secrets.ELASTICSEARCH_HOST }}
          ES_USERNAME: ${{ secrets.ELASTICSEARCH_USERNAME }}
          ES_PASSWORD: ${{ secrets.ELASTICSEARCH_PASSWORD }}
        run: |
          echo "ğŸš€ Starting data export process..."
          
          # Use our comprehensive static data update script
          echo "ğŸš€ Running comprehensive static data update (timestamp + location_info)..."
          
          # Run our update_static_data.py script that updates both timestamp and location data
          python update_static_data.py || {
              echo "âš ï¸ Static data update script failed, using fallback..."
              
              # Fallback: Update with current time if ES is unavailable
              timestamp_data="{
                \"lastUpdated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                \"human_readable\": \"$(date -u +'%B %d, %Y at %I:%M %p UTC')\",
                \"timestamp\": $(date +%s),
                \"source\": \"github_actions_fallback\",
                \"note\": \"Elasticsearch unavailable - using current time\"
              }"
              
              echo "$timestamp_data" > react-app/public/api/last-updated.json
              echo "ğŸ“… Updated timestamp file in fallback mode"
              exit 0
          }
          
          echo "âœ… Dynamic timestamp update complete"
          
      - name: ğŸ“‹ Check for Changes
        id: changes
        run: |
          # Check if any data files were modified
          if git diff --quiet react-app/public/api/; then
            echo "No changes detected in static data files"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in static data files"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            # Show what changed
            echo "ğŸ“ Files modified:"
            git diff --name-only react-app/public/api/ || true
          fi
          
      - name: ğŸ”§ Set up Node.js for Build
        if: steps.changes.outputs.changes_detected == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: react-app/package-lock.json
          
      - name: ğŸ“¦ Install Node.js Dependencies
        if: steps.changes.outputs.changes_detected == 'true'
        working-directory: ./react-app
        run: npm ci
        
      - name: ğŸ—ï¸ Build React App
        if: steps.changes.outputs.changes_detected == 'true'
        working-directory: ./react-app
        env:
          REACT_APP_STATIC_DEMO: true
          CI: false  # Don't treat warnings as errors
        run: |
          echo "ğŸ—ï¸ Building React app for static demo..."
          npm run build
          
      - name: ğŸ“ Commit Updated Data
        if: steps.changes.outputs.changes_detected == 'true'
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add changed files
          git add react-app/public/api/
          git add react-app/build/ || true  # Build directory might not exist
          
          # Create commit with timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¤– Auto-update static demo data - $TIMESTAMP" \
                     -m "Updated by GitHub Actions workflow" \
                     -m "Data exported at: $TIMESTAMP"
          
          echo "âœ… Committed updated static data files"
          
      - name: ğŸš€ Push Changes
        if: steps.changes.outputs.changes_detected == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          
      - name: ğŸ“Š Workflow Summary
        run: |
          echo "## ğŸ¯ Static Demo Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.changes_detected }}" == "true" ]; then
            echo "- **Status:** âœ… Data updated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Static Files Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la react-app/public/api/*.json | head -10 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ”” Notify on Failure
        if: failure()
        run: |
          echo "âŒ Workflow failed - but this is expected for demo purposes"
          echo "In a real deployment, this would send notifications about failures"
          
  # Deploy to GitHub Pages after successful data update
  deploy:
    name: Deploy to GitHub Pages
    needs: update-data
    if: needs.update-data.outputs.changes_detected == 'true'
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: ğŸ›’ Checkout Updated Code
        uses: actions/checkout@v4
        with:
          ref: main  # Get the updated code
          
      - name: ğŸ”§ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: react-app/package-lock.json
          
      - name: ğŸ“¦ Install Dependencies
        working-directory: ./react-app
        run: npm ci
        
      - name: ğŸ—ï¸ Build for Production
        working-directory: ./react-app
        env:
          REACT_APP_STATIC_DEMO: true
          CI: false
        run: npm run build
        
      - name: ğŸ“‹ Setup Pages
        uses: actions/configure-pages@v3
        
      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: './react-app/build'
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2